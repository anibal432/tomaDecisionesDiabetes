<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Citas | Admin Log</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/nav.css">
    <link rel="stylesheet" href="css/citas.css">
</head>
<body>
<nav class="navbar">
    <div class="navbar-icon"><i class="fa-solid fa-clipboard-user"></i></div>
    <div class="logo">Admin Log</div>
    <ul>            
        <li><a href="iniciosecre.php"><i class="fas fa-home"></i> <span>Inicio</span></a></li>
                    <li><a href="insertusuarios.php"><i class="fa-solid fa-user-plus"></i> <span>Ingresar Medico</span></a></li>
            <li><a href="gestión_secretarias.php"><i class="fa-solid fa-id-card"></i> <span>Ingresar Secre</span></a></li>
                <li><a href="Citas.php" class="active"><i class="fa-solid fa-calendar-days"></i> <span>Agendar Cita</span></a></li>
        <li><a href="turnospacientes.php"><i class="fa-solid fa-ticket"></i><span>Turnos de Pacientes</span></a></li>
        <li><a href="Logout.php"><i class="fas fa-sign-out-alt"></i> <span>LogOut</span></a></li>
    </ul>
</nav>

<main class="main-content">
    <div class="calendar-container">
        <div class="calendar-header">
            <h2 class="calendar-title">
                Abril 2025            </h2>
            <div class="calendar-nav">
                <button class="nav-button" id="delete-citas-btn" style="margin: 0 10px;">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button class="nav-button" id="prev-month">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="nav-button" id="next-month">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <div class="calendar-grid">
            <div class="calendar-day-header">Lun</div>
            <div class="calendar-day-header">Mar</div>
            <div class="calendar-day-header">Mié</div>
            <div class="calendar-day-header">Jue</div>
            <div class="calendar-day-header">Vie</div>
            <div class="calendar-day-header">Sáb</div>
            <div class="calendar-day-header">Dom</div>
            
            <div class="calendar-day disabled-day"></div><div class="calendar-day disabled-day" data-date="2025-04-01" onclick="handleDayClick(this)"><div class="day-number">1</div></div><div class="calendar-day disabled-day" data-date="2025-04-02" onclick="handleDayClick(this)"><div class="day-number">2</div></div><div class="calendar-day disabled-day" data-date="2025-04-03" onclick="handleDayClick(this)"><div class="day-number">3</div></div><div class="calendar-day disabled-day" data-date="2025-04-04" onclick="handleDayClick(this)"><div class="day-number">4</div></div><div class="calendar-day disabled-day" data-date="2025-04-05" onclick="handleDayClick(this)"><div class="day-number">5</div></div><div class="calendar-day disabled-day" data-date="2025-04-06" onclick="handleDayClick(this)"><div class="day-number">6</div></div><div class="calendar-day disabled-day" data-date="2025-04-07" onclick="handleDayClick(this)"><div class="day-number">7</div></div><div class="calendar-day disabled-day" data-date="2025-04-08" onclick="handleDayClick(this)"><div class="day-number">8</div></div><div class="calendar-day disabled-day" data-date="2025-04-09" onclick="handleDayClick(this)"><div class="day-number">9</div></div><div class="calendar-day disabled-day" data-date="2025-04-10" onclick="handleDayClick(this)"><div class="day-number">10</div></div><div class="calendar-day disabled-day" data-date="2025-04-11" onclick="handleDayClick(this)"><div class="day-number">11</div></div><div class="calendar-day disabled-day" data-date="2025-04-12" onclick="handleDayClick(this)"><div class="day-number">12</div></div><div class="calendar-day disabled-day" data-date="2025-04-13" onclick="handleDayClick(this)"><div class="day-number">13</div></div><div class="calendar-day disabled-day" data-date="2025-04-14" onclick="handleDayClick(this)"><div class="day-number">14</div></div><div class="calendar-day disabled-day" data-date="2025-04-15" onclick="handleDayClick(this)"><div class="day-number">15</div></div><div class="calendar-day disabled-day" data-date="2025-04-16" onclick="handleDayClick(this)"><div class="day-number">16</div></div><div class="calendar-day disabled-day" data-date="2025-04-17" onclick="handleDayClick(this)"><div class="day-number">17</div></div><div class="calendar-day disabled-day" data-date="2025-04-18" onclick="handleDayClick(this)"><div class="day-number">18</div></div><div class="calendar-day disabled-day" data-date="2025-04-19" onclick="handleDayClick(this)"><div class="day-number">19</div></div><div class="calendar-day disabled-day" data-date="2025-04-20" onclick="handleDayClick(this)"><div class="day-number">20</div></div><div class="calendar-day disabled-day" data-date="2025-04-21" onclick="handleDayClick(this)"><div class="day-number">21</div></div><div class="calendar-day current-day disabled-day" data-date="2025-04-22" onclick="handleDayClick(this)"><div class="day-number">22</div></div><div class="calendar-day available-day" data-date="2025-04-23" onclick="handleDayClick(this)"><div class="day-number">23</div></div><div class="calendar-day disabled-day" data-date="2025-04-24" onclick="handleDayClick(this)"><div class="day-number">24</div></div><div class="calendar-day disabled-day" data-date="2025-04-25" onclick="handleDayClick(this)"><div class="day-number">25</div></div><div class="calendar-day available-day" data-date="2025-04-26" onclick="handleDayClick(this)"><div class="day-number">26</div></div><div class="calendar-day disabled-day" data-date="2025-04-27" onclick="handleDayClick(this)"><div class="day-number">27</div></div><div class="calendar-day available-day" data-date="2025-04-28" onclick="handleDayClick(this)"><div class="day-number">28</div></div><div class="calendar-day disabled-day" data-date="2025-04-29" onclick="handleDayClick(this)"><div class="day-number">29</div></div><div class="calendar-day available-day" data-date="2025-04-30" onclick="handleDayClick(this)"><div class="day-number">30</div></div><div class="calendar-day disabled-day"></div><div class="calendar-day disabled-day"></div><div class="calendar-day disabled-day"></div><div class="calendar-day disabled-day"></div>        </div>
    </div>
</main>

<div id="appointmentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Agendar Cita</h3>
            <button class="close-button" onclick="closeModal()">&times;</button>
        </div>
        
        <div class="form-container">
            <div class="medical-section">
                <div class="form-group">
                    <label for="medicoSelect">Médico:</label>
                    <select id="medicoSelect" class="form-control"></select>
                </div>
                
                <div class="form-group">
                    <label>Horarios disponibles:</label>
                    <div class="time-slots" id="timeSlots"></div>
                </div>
            </div>
            
            <div class="personal-data-section">
                <div class="form-group">
                    <label for="primerNombre">Primer Nombre:</label>
                    <input type="text" id="primerNombre" required>
                </div>
                
                <div class="form-group">
                    <label for="segundoNombre">Segundo Nombre:</label>
                    <input type="text" id="segundoNombre">
                </div>
                
                <div class="form-group">
                    <label for="primerApellido">Primer Apellido:</label>
                    <input type="text" id="primerApellido" required>
                </div>
                
                <div class="form-group">
                    <label for="segundoApellido">Segundo Apellido:</label>
                    <input type="text" id="segundoApellido">
                </div>
                
                <div class="form-group">
                    <label for="correoElectronico">Correo Electrónico:</label>
                    <input type="email" id="correoElectronico" required>
                </div>
                
                <div class="form-group">
                    <label for="numeroCelular">Número de Celular:</label>
                    <input type="tel" id="numeroCelular" required>
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveAppointment()">Guardar Cita</button>
            </div>
        </div>
    </div>
</div>

<div id="deleteCitasModal" class="delete-modal">
    <div class="delete-modal-content">
        <div class="delete-modal-header">
            <h3 class="delete-modal-title"><i class="fas fa-trash-alt"></i> Eliminar Citas</h3>
            <button class="close-button" onclick="closeDeleteModal()">&times;</button>
        </div>
        
        <div class="search-container">
            <div class="search-group">
                <input type="text" id="searchCitasInput" class="search-input" placeholder="Buscar citas...">
                <button class="clear-search" id="clearSearchBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <button class="search-btn" id="searchCitasBtn">
                Buscar
            </button>
        </div>
        
        <div class="citas-table-container">
            <table class="citas-table">
                <thead>
                    <tr>
                        <th>Paciente</th>
                        <th>Correo</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Médico</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="citasTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let selectedDate = '';
    let selectedTime = '';
    let selectedMedicoId = '';
    const timeSlots = ['07:00', '09:00', '11:00', '14:00', '16:00'];
    
    document.getElementById('prev-month').addEventListener('click', function() {
        let prevMonth = 4 - 1;
        let prevYear = 2025;
        
        if (prevMonth < 1) {
            prevMonth = 12;
            prevYear--;
        }
        
        window.location.href = `Citas.php?month=${prevMonth}&year=${prevYear}`;
    });

    document.getElementById('next-month').addEventListener('click', function() {
        let nextMonth = 4 + 1;
        let nextYear = 2025;
        
        if (nextMonth > 12) {
            nextMonth = 1;
            nextYear++;
        }
        
        window.location.href = `Citas.php?month=${nextMonth}&year=${nextYear}`;
    });

    document.addEventListener('DOMContentLoaded', function() {
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;
        
        const prevButton = document.getElementById('prev-month');
        
        if (2025 == currentYear && 4 == currentMonth) {
            prevButton.disabled = true;
        }
    });
    
    function handleDayClick(dayElement) {
        const date = dayElement.getAttribute('data-date');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const selectedDateObj = new Date(date);
        
        if (selectedDateObj < today || !dayElement.classList.contains('available-day')) {
            Swal.fire({
                title: 'Día no disponible',
                text: 'No se pueden agendar citas en días pasados o no disponibles',
                icon: 'info'
            });
            return;
        }
        
        selectedDate = date;
        document.getElementById('appointmentModal').style.display = 'block';
        document.getElementById('medicoSelect').innerHTML = '<option value="">Cargando médicos...</option>';
        loadAvailableDoctors(selectedDate);
    }
    
    function loadAvailableDoctors(date) {
        fetch('get_available_doctors.php?date=' + date)
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('medicoSelect');
                select.innerHTML = '';
                
                if (data.length === 0) {
                    select.innerHTML = '<option value="">No hay médicos disponibles</option>';
                    document.getElementById('timeSlots').innerHTML = '';
                    return;
                }
                
                data.forEach(medico => {
                    const option = document.createElement('option');
                    option.value = medico.IdMedico;
                    option.textContent = medico.nombre_completo;
                    select.appendChild(option);
                });
                
                select.addEventListener('change', function() {
                    selectedMedicoId = this.value;
                    loadTimeSlots(date, this.value);
                });
                
                if (data.length > 0) {
                    selectedMedicoId = data[0].IdMedico;
                    loadTimeSlots(date, data[0].IdMedico);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    
    function loadTimeSlots(date, medicoId) {
        fetch('get_available_times.php?date=' + date + '&medicoId=' + medicoId)
            .then(response => response.json())
            .then(data => {
                const timeSlotsContainer = document.getElementById('timeSlots');
                timeSlotsContainer.innerHTML = '';
                
                timeSlots.forEach(time => {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.textContent = time;
                    timeSlot.setAttribute('data-time', time);
                    
                    if (data.bookedTimes.includes(time)) {
                        timeSlot.classList.add('booked');
                        timeSlot.title = 'Este horario ya está reservado';
                        timeSlot.style.pointerEvents = 'none';
                        timeSlot.style.opacity = '0.6';
                    } else {
                        timeSlot.addEventListener('click', function() {
                            document.querySelectorAll('.time-slot').forEach(slot => {
                                slot.classList.remove('selected');
                            });
                            
                            this.classList.add('selected');
                            selectedTime = this.getAttribute('data-time');
                        });
                    }
                    
                    timeSlotsContainer.appendChild(timeSlot);
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    
    function saveAppointment() {
        if (!selectedTime) {
            Swal.fire({
                title: 'Error',
                text: 'Por favor seleccione un horario',
                icon: 'error'
            });
            return;
        }
        
        const appointmentData = {
            primerNombre: document.getElementById('primerNombre').value,
            segundoNombre: document.getElementById('segundoNombre').value,
            primerApellido: document.getElementById('primerApellido').value,
            segundoApellido: document.getElementById('segundoApellido').value,
            correoElectronico: document.getElementById('correoElectronico').value,
            numeroCelular: document.getElementById('numeroCelular').value,
            fecha: selectedDate,
            hora: selectedTime,
            IdMedico: selectedMedicoId,
            estado: 'pendiente'
        };
        
        if (!appointmentData.primerNombre || !appointmentData.primerApellido || 
            !appointmentData.correoElectronico || !appointmentData.numeroCelular) {
            Swal.fire({
                title: 'Error',
                text: 'Por favor complete todos los campos requeridos',
                icon: 'error'
            });
            return;
        }
        
        fetch('save_appointment.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(appointmentData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: 'Éxito',
                    text: 'Cita agendada correctamente',
                    icon: 'success'
                }).then(() => {
                    closeModal();
                    window.location.reload();
                });
            } else {
                Swal.fire({
                    title: 'Error',
                    text: data.message || 'Error al agendar la cita',
                    icon: 'error'
                });
            }
        })
        .catch(error => {
            Swal.fire({
                title: 'Error',
                text: 'Error en la conexión: ' + error,
                icon: 'error'
            });
        });
    }
    
    function closeModal() {
        document.getElementById('appointmentModal').style.display = 'none';
        selectedTime = '';
        selectedMedicoId = '';

        document.getElementById('primerNombre').value = '';
        document.getElementById('segundoNombre').value = '';
        document.getElementById('primerApellido').value = '';
        document.getElementById('segundoApellido').value = '';
        document.getElementById('correoElectronico').value = '';
        document.getElementById('numeroCelular').value = '';

        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected');
        });
    }

    function openDeleteModal() {
        document.getElementById('deleteCitasModal').style.display = 'block';
        loadCitas();
    }

    function closeDeleteModal() {
        document.getElementById('deleteCitasModal').style.display = 'none';
    }

    document.getElementById('delete-citas-btn').addEventListener('click', openDeleteModal);

    document.getElementById('searchCitasBtn').addEventListener('click', function() {
        loadCitas(document.getElementById('searchCitasInput').value);
    });

    document.getElementById('clearSearchBtn').addEventListener('click', function() {
        document.getElementById('searchCitasInput').value = '';
        this.style.display = 'none';
        loadCitas();
    });

    function loadCitas(searchTerm = '') {
        const tbody = document.getElementById('citasTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="loading-text"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>';
        
        fetch('get_citas.php?search=' + encodeURIComponent(searchTerm))
            .then(response => response.json())
            .then(data => {
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-results">No se encontraron citas</td></tr>';
                    return;
                }
                
                data.forEach(cita => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${cita.primer_nombre} ${cita.primer_apellido}</td>
                        <td>${cita.correo_electronico}</td>
                        <td>${cita.fecha}</td>
                        <td>${cita.hora}</td>
                        <td>${cita.nombre_medico}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteCita(${cita.id})">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="error-text">Error al cargar citas</td></tr>';
            });
    }

    function deleteCita(id) {
        Swal.fire({
            title: '¿Estás seguro?',
            text: "¡No podrás revertir esta acción!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('delete_cita.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: id })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire(
                            '¡Eliminada!',
                            'La cita ha sido eliminada.',
                            'success'
                        );
                        loadCitas(document.getElementById('searchCitasInput').value);
                    } else {
                        Swal.fire(
                            'Error',
                            'No se pudo eliminar la cita.',
                            'error'
                        );
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire(
                        'Error',
                        'Ocurrió un error al eliminar la cita.',
                        'error'
                    );
                });
            }
        });
    }

    const searchInput = document.getElementById('searchCitasInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    searchInput.addEventListener('input', function() {
        clearBtn.style.display = this.value ? 'block' : 'none';
    });
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        clearBtn.style.display = 'none';
        loadCitas();
        searchInput.focus();
    });
</script>
</body>
</html>
